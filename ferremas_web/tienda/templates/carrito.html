{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Ferremas | Carrito de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar-nav .nav-link:hover,
        .navbar-nav .dropdown-item:hover {
            color: #FFD54F !important;
            background-color: #5d403715 !important;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="{% static 'imagenes/ferremas.png' %}" alt="Ferremas" height="70" width="70"
                    style="border-radius: 10px;">
            </a>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/productos/">← Volver a productos</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido -->
    <div class="container mt-5">
        <h1 class="text-center mb-4">Carrito de Compras</h1>
        <div id="carritoContenedor" class="table-responsive"></div>
        <div id="carritoMensaje" class="text-center mt-3"></div>
    </div>

    <script>
        async function cargarCarrito() {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            const contenedor = document.getElementById('carritoContenedor');
            const mensaje = document.getElementById('carritoMensaje');

            if (!usuario) {
                mensaje.innerHTML = '<p class="text-danger">Debes iniciar sesión para ver el carrito.</p>';
                return;
            }

            try {
                const resCarrito = await fetch(`http://127.0.0.1:8000/api/carrito/?cliente=${usuario.id}`);
                const carritos = await resCarrito.json();
                if (carritos.length === 0) {
                    mensaje.innerHTML = '<p class="text-warning">Tu carrito está vacío.</p>';
                    return;
                }

                const carrito = carritos[0];
                const productoAgrupado = {}; // ← agrupador por ID de producto

                for (let item of carrito.items) {
                    if (!productoAgrupado[item.producto]) {
                        const resProd = await fetch(`http://127.0.0.1:8000/api/productos/${item.producto}/`);
                        const prod = await resProd.json();

                        productoAgrupado[item.producto] = {
                            nombre: prod.nombre,
                            imagen: prod.imagen,
                            precio: parseFloat(prod.precio),
                            cantidad: item.cantidad
                        };
                    } else {
                        productoAgrupado[item.producto].cantidad += item.cantidad;
                    }
                }

                let total = 0;
                let rows = '';

                for (const id in productoAgrupado) {
                    const prod = productoAgrupado[id];
                    const subtotal = prod.precio * prod.cantidad;
                    total += subtotal;

                    rows += `
                    <tr>
                        <td><img src="${prod.imagen || 'https://via.placeholder.com/100'}" width="100" class="img-thumbnail"></td>
                        <td>${prod.nombre}</td>
                        <td>${prod.cantidad}</td>
                        <td>$${prod.precio.toFixed(0)}</td>
                        <td>$${subtotal.toFixed(0)}</td>
                    </tr>
                `;
                }

                contenedor.innerHTML = `
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-dark text-center">
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end fw-bold">Total</td>
                            <td class="fw-bold">$${total.toFixed(0)}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            } catch (error) {
                console.error(error);
                mensaje.innerHTML = '<p class="text-danger">Error de conexión con la API.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', cargarCarrito);
    </script>
</body>

<footer class="bg-dark text-white text-center py-3 mt-5">
    <div class="container">
        <p class="mb-0">© 2025 Ferremas - Todos los derechos reservados</p>
        <p class="mb-0">Contacto: contacto@ferremas.cl | Tel: +56 9 1234 5678</p>
    </div>
</footer>

</html>