{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Ferremas | Carrito de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar-nav .nav-link:hover,
        .navbar-nav .dropdown-item:hover {
            color: #FFD54F !important;
            background-color: #5d403715 !important;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="{% static 'imagenes/ferremas.png' %}" alt="Ferremas" height="70" width="70"
                    style="border-radius: 10px;">
            </a>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/productos/">← Volver a productos</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido -->
    <div class="container mt-5">
        <h1 class="text-center mb-4">Carrito de Compras</h1>
        <div id="carritoContenedor" class="table-responsive"></div>
        <div id="carritoMensaje" class="text-center mt-3"></div>
    </div>

    <script>
        async function cargarCarrito() {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            const contenedor = document.getElementById('carritoContenedor');
            const mensaje = document.getElementById('carritoMensaje');

            if (!usuario) {
                mensaje.innerHTML = '<p class="text-danger">Debes iniciar sesión para ver el carrito.</p>';
                return;
            }

            try {
                const resCarrito = await fetch(`http://127.0.0.1:8000/api/carrito/?cliente=${usuario.id}`);
                const carritos = await resCarrito.json();
                if (carritos.length === 0) {
                    mensaje.innerHTML = '<p class="text-warning">Tu carrito está vacío.</p>';
                    return;
                }

                const carrito = carritos[0];
                const productoAgrupado = {}; // ← agrupador por ID de producto

                for (let item of carrito.items) {
                    if (!productoAgrupado[item.producto]) {
                        const resProd = await fetch(`http://127.0.0.1:8000/api/productos/${item.producto}/`);
                        const prod = await resProd.json();

                        productoAgrupado[item.producto] = {
                            nombre: prod.nombre,
                            imagen: prod.imagen,
                            precio: parseFloat(prod.precio),
                            totalCantidad: item.cantidad,
                            items: [{ id: item.id, cantidad: item.cantidad }]
                        };

                    } else {
                        productoAgrupado[item.producto].totalCantidad += item.cantidad;
                        productoAgrupado[item.producto].items.push({ id: item.id, cantidad: item.cantidad });
                    }
                }

                let total = 0;
                let rows = '';

                for (const id in productoAgrupado) {
                    const prod = productoAgrupado[id];
                    const itemId = prod.items[0].id;
                    const subtotal = prod.precio * prod.totalCantidad;
                    total += subtotal;

                    rows += `
                    <tr>
                        <td><img src="${prod.imagen || 'https://via.placeholder.com/100'}" width="100" class="img-thumbnail"></td>
                        <td>${prod.nombre}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="actualizarCantidad(${prod.items[0].id}, -1)">−</button>
                            ${prod.totalCantidad}
                            <button class="btn btn-sm btn-outline-secondary ms-1" onclick="actualizarCantidad(${prod.items[0].id}, 1)">+</button>
                        </td>
                        <td>$${prod.precio.toFixed(0)}</td>
                        <td>$${subtotal.toFixed(0)}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-danger" onclick='eliminarProducto(${JSON.stringify(prod.items.map(i => i.id))})'>❌</button>
                        </td>
                    </tr>`;
                }

                contenedor.innerHTML = `
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-dark text-center">
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end fw-bold">Total</td>
                                <td class="fw-bold"><span id="carrito-total-clp">${total.toFixed(0)}</span></td>
                            </td>
                        </tr>
                    </tfoot>
                </table>
                <div class="text-center mt-3">
                    <label for="currency-selector" class="form-label">Convertir total a:</label>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <select id="currency-selector" class="form-select w-auto">
                            <option value="AED">Dirham de los Emiratos Árabes Unidos (AED)</option>
                        <option value="ARS">Peso argentino (ARS)</option>
                        <option value="AUD">Dólar australiano (AUD)</option>
                        <option value="BGN">Lev búlgaro (BGN)</option>
                        <option value="BRL">Real brasileño (BRL)</option>
                        <option value="BSD">Dólar bahameño (BSD)</option>
                        <option value="CAD">Dólar canadiense (CAD)</option>
                        <option value="CHF">Franco suizo (CHF)</option>
                        <option value="CLP">Peso chileno (CLP)</option>
                        <option value="CNY">Yuan chino (CNY)</option>
                        <option value="COP">Peso colombiano (COP)</option>
                        <option value="CZK">Corona checa (CZK)</option>
                        <option value="DKK">Corona danesa (DKK)</option>
                        <option value="DOP">Peso dominicano (DOP)</option>
                        <option value="EGP">Libra egipcia (EGP)</option>
                        <option value="EUR">Euro (EUR)</option>
                        <option value="FJD">Dólar fiyiano (FJD)</option>
                        <option value="GBP">Libra esterlina (GBP)</option>
                        <option value="GTQ">Quetzal guatemalteco (GTQ)</option>
                        <option value="HKD">Dólar de Hong Kong (HKD)</option>
                        <option value="HRK">Kuna croata (HRK)</option>
                        <option value="HUF">Forinto húngaro (HUF)</option>
                        <option value="IDR">Rupia indonesia (IDR)</option>
                        <option value="ILS">Nuevo shequel israelí (ILS)</option>
                        <option value="INR">Rupia india (INR)</option>
                        <option value="ISK">Corona islandesa (ISK)</option>
                        <option value="JPY">Yen japonés (JPY)</option>
                        <option value="KRW">Won surcoreano (KRW)</option>
                        <option value="KZT">Tenge kazajo (KZT)</option>
                        <option value="MXN">Peso mexicano (MXN)</option>
                        <option value="MYR">Ringgit malayo (MYR)</option>
                        <option value="NOK">Corona noruega (NOK)</option>
                        <option value="NZD">Dólar neozelandés (NZD)</option>
                        <option value="PAB">Balboa panameño (PAB)</option>
                        <option value="PEN">Sol peruano (PEN)</option>
                        <option value="PHP">Peso filipino (PHP)</option>
                        <option value="PKR">Rupia paquistaní (PKR)</option>
                        <option value="PLN">Złoty polaco (PLN)</option>
                        <option value="PYG">Guaraní paraguayo (PYG)</option>
                        <option value="RON">Leu rumano (RON)</option>
                        <option value="RUB">Rublo ruso (RUB)</option>
                        <option value="SAR">Riyal saudí (SAR)</option>
                        <option value="SEK">Corona sueca (SEK)</option>
                        <option value="SGD">Dólar de Singapur (SGD)</option>
                        <option value="THB">Baht tailandés (THB)</option>
                        <option value="TRY">Lira turca (TRY)</option>
                        <option value="TWD">Nuevo dólar taiwanés (TWD)</option>
                        <option value="UAH">Grivna ucraniana (UAH)</option>
                        <option value="USD" selected>Dólar estadounidense (USD)</option>
                        <option value="UYU">Peso uruguayo (UYU)</option>
                        <option value="VND">Dong vietnamita (VND)</option>
                        <option value="ZAR">Rand sudafricano (ZAR)</option>
                        </select>
                        <button class="btn btn-outline-primary" onclick="convertirCarritoMoneda()">Convertir</button>
                    </div>
                    <p id="carrito-total-convertido" class="mt-3 fw-bold text-primary"></p>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-outline-danger" onclick="vaciarCarrito()">🗑️ Vaciar Carrito</button>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-success" onclick="iniciarPago()">💳 Pagar con Webpay</button>
                </div>
            `;

            } catch (error) {
                console.error(error);
                mensaje.innerHTML = '<p class="text-danger">Error de conexión con la API.</p>';
            }
        }

        async function actualizarCantidad(idItemCarrito, cambio) {
            try {
                const resItem = await fetch(`http://127.0.0.1:8000/api/items-carrito/${idItemCarrito}/`);
                const item = await resItem.json();

                let nuevaCantidad = item.cantidad + cambio;
                if (nuevaCantidad < 1) return eliminarProducto(idItemCarrito);

                await fetch(`http://127.0.0.1:8000/api/items-carrito/${idItemCarrito}/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cantidad: nuevaCantidad })
                });

                cargarCarrito();
            } catch (e) {
                console.error('Error al actualizar cantidad:', e);
            }
        }

        async function eliminarProducto(itemIds) {
            try {
                for (const id of itemIds) {
                    await fetch(`http://127.0.0.1:8000/api/items-carrito/${id}/`, {
                        method: 'DELETE'
                    });
                }
                cargarCarrito();
            } catch (e) {
                console.error('Error al eliminar producto:', e);
            }
        }

        async function vaciarCarrito() {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario) return;

            try {
                // Obtener el carrito del usuario
                const carritoRes = await fetch(`http://127.0.0.1:8000/api/carrito/?cliente=${usuario.id}`);
                const carritoData = await carritoRes.json();
                if (carritoData.length === 0) return;

                const carritoId = carritoData[0].id;

                // Obtener todos los ítems del carrito directamente
                const itemsRes = await fetch(`http://127.0.0.1:8000/api/items-carrito/?carrito=${carritoId}`);
                const itemsData = await itemsRes.json();

                // Eliminar cada ítem
                for (const item of itemsData) {
                    await fetch(`http://127.0.0.1:8000/api/items-carrito/${item.id}/`, {
                        method: 'DELETE'
                    });
                }

                cargarCarrito();
            } catch (e) {
                console.error('Error al vaciar el carrito:', e);
            }
        }


        document.addEventListener('DOMContentLoaded', cargarCarrito);
    </script>
    <script>
        function convertirCarritoMoneda() {
            const monedaDestino = document.getElementById("currency-selector").value;
            const totalCLP = parseFloat(document.getElementById("carrito-total-clp").innerText); // asume un span con total en CLP

            fetch(`http://127.0.0.1:8000/api/conversion/?moneda=${monedaDestino}`)
                .then(response => response.json())
                .then(data => {
                    if (data.tasa_conversion) {
                        const totalConvertido = totalCLP * data.tasa_conversion;
                        document.getElementById("carrito-total-convertido").innerText =
                            `Total: ${totalConvertido.toFixed(2)} ${monedaDestino}`;
                    } else {
                        alert("No se pudo obtener la tasa de conversión.");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Error al procesar la conversión.");
                });
        }
    </script>
    <script>
        const iniciarPago = async () => {
            try {
                // Mostrar algún indicador de carga
                const totalCLP = parseFloat(document.getElementById("carrito-total-clp").innerText);

                const response = await fetch("http://127.0.0.1:8000/api/webpay/create/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ amount: totalCLP })
                });

                const data = await response.json();

                if (!response.ok) {
                    console.error("Error en la respuesta del servidor:", data.error || data);
                    alert("Hubo un error al iniciar el pago. Por favor, intenta nuevamente más tarde.");
                    return;
                }

                // Redirigir al usuario a la página de pago de WebPay
                window.location.href = data.url;
            } catch (err) {
                console.error("Error al iniciar pago:", err);
                alert("Error de conexión. Por favor, verifica tu conexión a internet e intenta nuevamente.");
            }
        };
    </script>
</body>

<footer class="bg-dark text-white text-center py-3 mt-5">
    <div class="container">
        <p class="mb-0">© 2025 Ferremas - Todos los derechos reservados</p>
        <p class="mb-0">Contacto: contacto@ferremas.cl | Tel: +56 9 1234 5678</p>
    </div>
</footer>

</html>